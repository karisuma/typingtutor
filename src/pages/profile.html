<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="íƒ€ì ì—°ìŠµ í”„ë¡œê·¸ë¨ - ë‚´ í”„ë¡œí•„">
    <title>ë‚´ í”„ë¡œí•„ | íƒ€ì ì—°ìŠµ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/typing_64.png">
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* í”„ë¡œí•„ í˜ì´ì§€ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: calc(80px + var(--spacing-2xl)) var(--spacing-xl) var(--spacing-2xl);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
            padding: var(--spacing-xl);
            background: var(--color-bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: var(--radius-full);
            background: var(--color-accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-4xl);
            font-weight: 700;
            color: white;
        }

        .profile-info h1 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--spacing-sm);
        }

        .profile-info p {
            color: var(--color-text-secondary);
        }

        .profile-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-md);
            background: rgba(99, 102, 241, 0.2);
            color: var(--color-accent-primary);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-top: var(--spacing-sm);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-card {
            background: var(--color-bg-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-md);
        }

        .stat-card .value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--color-accent-primary);
            margin-bottom: var(--spacing-sm);
        }

        .stat-card .label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }

        .chart-card {
            background: var(--color-bg-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
        }

        .chart-card h3 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .records-section {
            background: var(--color-bg-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
        }

        .records-section h3 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-lg);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
        }

        .records-table th,
        .records-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .records-table th {
            color: var(--color-text-muted);
            font-weight: 500;
            font-size: var(--font-size-sm);
        }

        .records-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .mode-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
        }

        .mode-badge.position {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .mode-badge.word {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .mode-badge.sentence {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .mode-badge.longtext {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--color-text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-lg);
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .records-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <span class="logo-icon">âŒ¨ï¸</span>
                <span class="logo-text">íƒ€ì ì—°ìŠµ</span>
            </a>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="../index.html" class="nav-link">ì—°ìŠµí•˜ê¸°</a>
                </li>
                <li class="nav-item">
                    <a href="profile.html" class="nav-link active">ë‚´ í”„ë¡œí•„</a>
                </li>
            </ul>
            <div class="nav-auth" id="navAuth">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="profile-container">
        <!-- ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ -->
        <div class="empty-state hidden" id="loginRequired">
            <div class="icon">ğŸ”</div>
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p>í”„ë¡œí•„ì„ í™•ì¸í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>
            <br>
            <a href="../index.html" class="btn btn-primary">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <!-- í”„ë¡œí•„ ì»¨í…ì¸  -->
        <div id="profileContent" class="hidden">
            <!-- í”„ë¡œí•„ í—¤ë” -->
            <div class="profile-header">
                <div class="profile-avatar" id="userAvatar">U</div>
                <div class="profile-info">
                    <h1 id="userName">ì‚¬ìš©ì</h1>
                    <p id="userEmail">user@example.com</p>
                    <span class="profile-badge" id="userRole">í•™ìƒ</span>
                </div>
            </div>

            <!-- í†µê³„ ìš”ì•½ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">ğŸ“Š</div>
                    <div class="value" id="statPracticeCount">0</div>
                    <div class="label">ì´ ì—°ìŠµ íšŸìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="icon">â±ï¸</div>
                    <div class="value" id="statTotalTime">0ë¶„</div>
                    <div class="label">ì´ ì—°ìŠµ ì‹œê°„</div>
                </div>
                <div class="stat-card">
                    <div class="icon">âš¡</div>
                    <div class="value" id="statAvgSpeed">0</div>
                    <div class="label">í‰ê·  íƒ€ìˆ˜ (íƒ€/ë¶„)</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ¯</div>
                    <div class="value" id="statAvgAccuracy">0%</div>
                    <div class="label">í‰ê·  ì •í™•ë„</div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
            <div class="charts-section">
                <div class="chart-card">
                    <h3>ğŸ“ˆ íƒ€ìˆ˜ ì„±ì¥ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="speedChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ¯ ì •í™•ë„ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="accuracyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ì—°ìŠµ ê¸°ë¡ -->
            <div class="records-section">
                <h3>ğŸ“‹ ìµœê·¼ ì—°ìŠµ ê¸°ë¡</h3>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ëª¨ë“œ</th>
                            <th>ì–¸ì–´</th>
                            <th>ì‹œê°„</th>
                            <th>íƒ€ìˆ˜</th>
                            <th>ì •í™•ë„</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
                <div class="empty-state hidden" id="noRecords">
                    <div class="icon">ğŸ“</div>
                    <p>ì•„ì§ ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <br>
                    <a href="../index.html" class="btn btn-primary">ì—°ìŠµ ì‹œì‘í•˜ê¸°</a>
                </div>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2026 íƒ€ì ì—°ìŠµ í”„ë¡œê·¸ë¨. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/api-config.js"></script>
    <script src="../js/api-client.js"></script>
    <script src="../js/storage.js"></script>
    <script>
        // í”„ë¡œí•„ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            initProfilePage();
        });

        async function initProfilePage() {
            // Storage ì´ˆê¸°í™” ëŒ€ê¸° (API ì—°ê²° ë“±)
            await Storage.init();

            const user = Storage.getCurrentUser();

            if (!user) {
                // ë¡œê·¸ì¸ ì•ˆ ë¨
                document.getElementById('loginRequired').classList.remove('hidden');
                document.getElementById('profileContent').classList.add('hidden');
                updateNavAuth(null);
                return;
            }

            // ë¡œê·¸ì¸ ë¨
            document.getElementById('loginRequired').classList.add('hidden');
            document.getElementById('profileContent').classList.remove('hidden');

            updateNavAuth(user);
            loadUserProfile(user);

            // ë°ì´í„° ë¡œë”© ì¤‘ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
            document.getElementById('recordsBody').innerHTML = '<tr><td colspan="6" style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>';

            try {
                // API ë˜ëŠ” ë¡œì»¬ì—ì„œ ê¸°ë¡ ì¡°íšŒ
                const records = await Storage.getRecordsByUser(user.id);

                loadUserStats(records);
                loadGrowthCharts(records);
                loadRecentRecords(records);
            } catch (error) {
                console.error('Failed to load records:', error);
                document.getElementById('recordsBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
            }
        }

        function updateNavAuth(user) {
            const navAuth = document.getElementById('navAuth');
            if (!navAuth) return;

            if (user) {
                const isAdmin = user.role === 'admin';
                navAuth.innerHTML = `
                    <span style="color: var(--color-accent-primary); font-weight: 500;">${user.name}ë‹˜</span>
                    ${isAdmin ? '<a href="../admin/index.html" class="btn btn-ghost">ê´€ë¦¬ì</a>' : ''}
                    <button class="btn btn-ghost" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                `;
            } else {
                navAuth.innerHTML = `
                    <a href="../index.html" class="btn btn-primary">ë¡œê·¸ì¸</a>
                `;
            }
        }

        function handleLogout() {
            Storage.logout();
            window.location.href = '../index.html';
        }

        function loadUserProfile(user) {
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'ê´€ë¦¬ì' : 'í•™ìƒ';
        }

        function loadUserStats(records) {
            const practiceCount = records.length;
            const totalTime = records.reduce((sum, r) => sum + (r.duration || 0), 0);
            const avgSpeed = practiceCount > 0
                ? Math.round(records.reduce((sum, r) => sum + r.speed, 0) / practiceCount)
                : 0;
            const avgAccuracy = practiceCount > 0
                ? Math.round(records.reduce((sum, r) => sum + r.accuracy, 0) / practiceCount)
                : 0;

            document.getElementById('statPracticeCount').textContent = practiceCount;
            document.getElementById('statTotalTime').textContent = Math.round(totalTime / 60) + 'ë¶„';
            document.getElementById('statAvgSpeed').textContent = avgSpeed;
            document.getElementById('statAvgAccuracy').textContent = avgAccuracy + '%';
        }

        function loadGrowthCharts(records) {
            // recordsë¥¼ ê¸°ë°˜ìœ¼ë¡œ growthData ê³„ì‚° (Storage.getGrowthData ëŒ€ì‹  ì§ì ‘ ê³„ì‚°í•˜ì—¬ API í˜¸ì¶œ ì ˆì•½)
            const days = 14;
            const now = new Date();
            const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

            const dailyData = {};

            records.forEach(record => {
                const date = new Date(record.createdAt);
                if (date >= startDate) {
                    const dateKey = date.toISOString().split('T')[0];
                    if (!dailyData[dateKey]) {
                        dailyData[dateKey] = {
                            date: dateKey,
                            speed: [],
                            accuracy: [],
                            count: 0
                        };
                    }
                    dailyData[dateKey].speed.push(record.speed);
                    dailyData[dateKey].accuracy.push(record.accuracy);
                    dailyData[dateKey].count++;
                }
            });

            const growthData = Object.values(dailyData).map(day => ({
                date: day.date,
                avgSpeed: Math.round(day.speed.reduce((a, b) => a + b, 0) / day.speed.length),
                avgAccuracy: Math.round(day.accuracy.reduce((a, b) => a + b, 0) / day.accuracy.length),
                practiceCount: day.count
            })).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (growthData.length === 0) {
                return;
            }

            const labels = growthData.map(d => {
                const date = new Date(d.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const speedData = growthData.map(d => d.avgSpeed);
            const accuracyData = growthData.map(d => d.avgAccuracy);

            // ì°¨íŠ¸ ë Œë”ë§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
            // íƒ€ìˆ˜ ì°¨íŠ¸
            const speedCtx = document.getElementById('speedChart').getContext('2d');
            new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'íƒ€ìˆ˜ (íƒ€/ë¶„)',
                        data: speedData,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#6a6a80' } },
                        x: { grid: { display: false }, ticks: { color: '#6a6a80' } }
                    }
                }
            });

            // ì •í™•ë„ ì°¨íŠ¸
            const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
            new Chart(accuracyCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì •í™•ë„ (%)',
                        data: accuracyData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#6a6a80' } },
                        x: { grid: { display: false }, ticks: { color: '#6a6a80' } }
                    }
                }
            });
        }

        function loadRecentRecords(records) {
            const tbody = document.getElementById('recordsBody');
            const noRecords = document.getElementById('noRecords');

            if (records.length === 0) {
                noRecords.classList.remove('hidden');
                tbody.innerHTML = '';
                return;
            }

            noRecords.classList.add('hidden');

            const recentRecords = records.slice(-20).reverse();

            const modeNames = {
                'position': 'ìë¦¬ì—°ìŠµ',
                'word': 'ë‹¨ì–´ì—°ìŠµ',
                'sentence': 'ë¬¸ì¥ì—°ìŠµ',
                'longtext': 'ì¥ë¬¸ì—°ìŠµ'
            };

            const languageNames = {
                'korean': 'í•œê¸€',
                'english': 'ì˜ì–´'
            };

            tbody.innerHTML = recentRecords.map(record => {
                const date = new Date(record.createdAt);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                const duration = record.duration || 0;
                const mins = Math.floor(duration / 60);
                const secs = duration % 60;
                const durationStr = `${mins}ë¶„ ${secs}ì´ˆ`;

                return `
                    <tr>
                        <td>${dateStr} ${timeStr}</td>
                        <td><span class="mode-badge ${record.mode}">${modeNames[record.mode] || record.mode}</span></td>
                        <td>${languageNames[record.language] || record.language}</td>
                        <td>${durationStr}</td>
                        <td>${record.speed} íƒ€/ë¶„</td>
                        <td>${record.accuracy}%</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>

</html>